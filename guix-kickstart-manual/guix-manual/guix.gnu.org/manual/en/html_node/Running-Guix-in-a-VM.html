<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!--   Copyright (C) 2012-2022 Ludovic Courtès

Copyright (C) 2013, 2014, 2016 Andreas Enge

Copyright (C) 2013 Nikita Karetnikov

Copyright (C) 2014, 2015, 2016 Alex Kost

Copyright (C) 2015, 2016 Mathieu Lirzin

Copyright (C) 2014 Pierre-Antoine Rault

Copyright (C) 2015 Taylan Ulrich Bayırlı/Kammer

Copyright (C) 2015, 2016, 2017, 2019, 2020, 2021 Leo Famulari

Copyright (C) 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022 Ricardo Wurmus

Copyright (C) 2016 Ben Woodcroft

Copyright (C) 2016, 2017, 2018, 2021 Chris Marusich

Copyright (C) 2016, 2017, 2018, 2019, 2020, 2021, 2022 Efraim Flashner

Copyright (C) 2016 John Darrington

Copyright (C) 2016, 2017 Nikita Gillmann

Copyright (C) 2016, 2017, 2018, 2019, 2020 Jan Nieuwenhuizen

Copyright (C) 2016, 2017, 2018, 2019, 2020, 2021 Julien Lepiller

Copyright (C) 2016 Alex ter Weele

Copyright (C) 2016, 2017, 2018, 2019, 2020, 2021 Christopher Baines

Copyright (C) 2017, 2018, 2019 Clément Lassieur

Copyright (C) 2017, 2018, 2020, 2021, 2022 Mathieu Othacehe

Copyright (C) 2017 Federico Beffa

Copyright (C) 2017, 2018 Carlo Zancanaro

Copyright (C) 2017 Thomas Danckaert

Copyright (C) 2017 humanitiesNerd

Copyright (C) 2017, 2021 Christine Lemmer-Webber

Copyright (C) 2017, 2018, 2019, 2020, 2021, 2022 Marius Bakke

Copyright (C) 2017, 2019, 2020, 2022 Hartmut Goebel

Copyright (C) 2017, 2019, 2020, 2021, 2022 Maxim Cournoyer

Copyright (C) 2017–2022 Tobias Geerinckx-Rice

Copyright (C) 2017 George Clemmer

Copyright (C) 2017 Andy Wingo

Copyright (C) 2017, 2018, 2019, 2020 Arun Isaac

Copyright (C) 2017 nee

Copyright (C) 2018 Rutger Helling

Copyright (C) 2018, 2021 Oleg Pykhalov

Copyright (C) 2018 Mike Gerwitz

Copyright (C) 2018 Pierre-Antoine Rouby

Copyright (C) 2018, 2019 Gábor Boskovits

Copyright (C) 2018, 2019, 2020, 2022 Florian Pelz

Copyright (C) 2018 Laura Lazzati

Copyright (C) 2018 Alex Vong

Copyright (C) 2019 Josh Holland

Copyright (C) 2019, 2020 Diego Nicola Barbato

Copyright (C) 2019 Ivan Petkov

Copyright (C) 2019 Jakob L. Kreuze

Copyright (C) 2019 Kyle Andrews

Copyright (C) 2019 Alex Griffin

Copyright (C) 2019, 2020, 2021, 2022 Guillaume Le Vaillant

Copyright (C) 2020 Liliana Marie Prikler

Copyright (C) 2019, 2020, 2021, 2022 Simon Tournier

Copyright (C) 2020 Wiktor Żelazny

Copyright (C) 2020 Damien Cassou

Copyright (C) 2020 Jakub Kądziołka

Copyright (C) 2020 Jack Hill

Copyright (C) 2020 Naga Malleswari

Copyright (C) 2020, 2021 Brice Waegeneire

Copyright (C) 2020 R Veera Kumar

Copyright (C) 2020, 2021 Pierre Langlois

Copyright (C) 2020 pinoaffe

Copyright (C) 2020 André Batista

Copyright (C) 2020, 2021 Alexandru-Sergiu Marton

Copyright (C) 2020 raingloom

Copyright (C) 2020 Daniel Brooks

Copyright (C) 2020 John Soo

Copyright (C) 2020 Jonathan Brielmaier

Copyright (C) 2020 Edgar Vincent

Copyright (C) 2021, 2022 Maxime Devos

Copyright (C) 2021 B. Wilson

Copyright (C) 2021 Xinglu Chen

Copyright (C) 2021 Raghav Gururajan

Copyright (C) 2021 Domagoj Stolfa

Copyright (C) 2021 Hui Lu

Copyright (C) 2021 pukkamustard

Copyright (C) 2021 Alice Brenon

Copyright (C) 2021, 2022 Josselin Poiret

Copyright (C) 2021 muradm

Copyright (C) 2021, 2022 Andrew Tropin

Copyright (C) 2021 Sarah Morgensen

Copyright (C) 2022 Remco van 't Veer

Copyright (C) 2022 Aleksandr Vityazev

Copyright (C) 2022 Philip McGrath

Copyright (C) 2022 Karl Hallsby

Copyright (C) 2022 Justin Veilleux

Copyright (C) 2022 Reily Siegel

Copyright (C) 2022 Simon Streit

Copyright (C) 2022 (

Copyright (C) 2022 John Kehayias


Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with no
Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.  A
copy of the license is included in the section entitled "GNU Free
Documentation License".   -->
<!--   Created by GNU Texinfo 6.7, http://www.gnu.org/software/texinfo/   -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Running Guix in a VM (GNU Guix Reference Manual)</title>

<meta name="description" content="Running Guix in a VM (GNU Guix Reference Manual)" />
<meta name="keywords" content="Running Guix in a VM (GNU Guix Reference Manual)" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="Generator" content="makeinfo" />
<link href="index.html" rel="start" title="Top" />
<link href="Concept-Index.html" rel="index" title="Concept Index" />
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents" />
<link href="System-Configuration.html" rel="up" title="System Configuration" />
<link href="Defining-Services.html" rel="next" title="Defining Services" />
<link href="Invoking-guix-deploy.html" rel="prev" title="Invoking guix deploy" />
<style type="text/css">
&amp;lt;!--
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
div.lisp {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
ul.no-bullet {list-style: none}
--&amp;gt;
</style>
<link rel="stylesheet" type="text/css" href="https://www.gnu.org/software/gnulib/manual.css" />

<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" type="text/css" href="../../../static/base/css/manual.css" /><link rel="stylesheet" type="text/css" href="../../../static/base/css/code.css" /></head>

<body lang="en"><header class="navbar"><h1><a class="branding" href="https://guix.gnu.org/manual/en/"></a></h1><nav class="navbar-menu"><input class="navbar-menu-hidden-input" type="radio" name="dropdown" id="all-dropdowns-hidden" /><ul><li class="navbar-menu-item dropdown dropdown-btn"><input class="navbar-menu-hidden-input" type="radio" name="dropdown" id="visible-dropdown" /><label for="visible-dropdown"><img alt="Language" src="../../../static/base/img/language-picker.svg" /></label><label for="all-dropdowns-hidden"><img alt="Language" src="../../../static/base/img/language-picker.svg" /></label><div class="navbar-submenu" id="navbar-submenu"><div class="navbar-submenu-triangle"> </div><ul><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/de/html_node">Deutsch</a></li><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/en/html_node">English</a></li><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/es/html_node">Español</a></li><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/fr/html_node">français</a></li><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/pt-br/html_node">Português</a></li><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/ru/html_node">русский</a></li><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/zh-cn/html_node">中文</a></li><li><a class="navbar-menu-item" href="https://translate.fedoraproject.org/projects/guix/documentation-manual/">⊕</a></li></ul></div></li></ul></nav><a class="navbar-menu-btn" href="https://guix.gnu.org/manual/"></a></header>
<span id="Running-Guix-in-a-VM"></span><div class="header">
<p>
Next: <a href="Defining-Services.html" accesskey="n" rel="next">Defining Services</a>, Previous: <a href="Invoking-guix-deploy.html" accesskey="p" rel="prev">Invoking guix deploy</a>, Up: <a href="System-Configuration.html" accesskey="u" rel="up">System Configuration</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Concept-Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr />
<span id="Running-Guix-in-a-Virtual-Machine"></span><h3 class="section">12.17 Running Guix in a Virtual Machine</h3>

<span id="index-virtual-machine-1"></span>
<p>To run Guix in a virtual machine (VM), one can use the pre-built Guix VM
image distributed at
<a href="https://ftp.gnu.org/gnu/guix/guix-system-vm-image-1.4.0.x86_64-linux.qcow2">https://ftp.gnu.org/gnu/guix/guix-system-vm-image-1.4.0.x86_64-linux.qcow2</a>.
This image is a compressed image in QCOW format.  You can pass it to an
emulator such as <a href="https://qemu.org/">QEMU</a> (see below for details).
</p>
<p>This image boots the Xfce graphical environment and it contains some
commonly used tools.  You can install more software in the image by running
<code>guix package</code> in a terminal (see <a href="Invoking-guix-package.html">Invoking guix package</a>).  You can
also reconfigure the system based on its initial configuration file available
as <samp>/run/current-system/configuration.scm</samp> (see <a href="Using-the-Configuration-System.html">Using the Configuration System</a>).
</p>
<p>Instead of using this pre-built image, one can also build their own
image using <code>guix system image</code> (see <a href="Invoking-guix-system.html">Invoking guix system</a>).
</p>
<span id="index-QEMU"></span>
<p>If you built your own image, you must copy it out of the store
(see <a href="The-Store.html">The Store</a>) and give yourself permission to write to the copy
before you can use it.  When invoking QEMU, you must choose a system
emulator that is suitable for your hardware platform.  Here is a minimal
QEMU invocation that will boot the result of <code>guix system
image -t qcow2</code> on x86_64 hardware:
</p>
<div class="example">
<pre class="example">$ qemu-system-x86_64 \
   -nic user,model=virtio-net-pci \
   -enable-kvm -m 2048 \
   -device virtio-blk,drive=myhd \
   -drive if=none,file=guix-system-vm-image-1.4.0.x86_64-linux.qcow2,id=myhd
</pre></div>

<p>Here is what each of these options means:
</p>
<dl compact="compact">
<dt><code>qemu-system-x86_64</code></dt>
<dd><p>This specifies the hardware platform to emulate.  This should match the
host.
</p>
</dd>
<dt><code>-nic user,model=virtio-net-pci</code></dt>
<dd><p>Enable the unprivileged user-mode network stack.  The guest OS can
access the host but not vice versa.  This is the simplest way to get the
guest OS online.  <code>model</code> specifies which network device to emulate:
<code>virtio-net-pci</code> is a special device made for virtualized operating
systems and recommended for most uses.  Assuming your hardware platform is
x86_64, you can get a list of available NIC models by running
<code>qemu-system-x86_64 -nic model=help</code>.
</p>
</dd>
<dt><code>-enable-kvm</code></dt>
<dd><p>If your system has hardware virtualization extensions, enabling the
virtual machine support (KVM) of the Linux kernel will make things run
faster.
</p>
</dd>
<dt><code>-m 2048</code></dt>
<dd><p>RAM available to the guest OS, in mebibytes.  Defaults to 128&nbsp;MiB,
which may be insufficient for some operations.
</p>
</dd>
<dt><code>-device virtio-blk,drive=myhd</code></dt>
<dd><p>Create a <code>virtio-blk</code> drive called &ldquo;myhd&rdquo;.  <code>virtio-blk</code> is a
&ldquo;paravirtualization&rdquo; mechanism for block devices that allows QEMU to achieve
better performance than if it were emulating a complete disk drive.  See the
QEMU and KVM documentation for more info.
</p>
</dd>
<dt><code>-drive if=none,file=/tmp/qemu-image,id=myhd</code></dt>
<dd><p>Use our QCOW image, the
<samp>guix-system-vm-image-1.4.0.x86_64-linux.qcow2</samp> file, as
the backing store of the &ldquo;myhd&rdquo; drive.
</p></dd>
</dl>

<p>The default <code>run-vm.sh</code> script that is returned by an invocation of
<code>guix system vm</code> does not add a <code>-nic user</code> flag by default.
To get network access from within the vm add the <code>(dhcp-client-service)</code>
to your system definition and start the VM using
<code>$(guix system vm config.scm) -nic user</code>.  An important caveat of using
<code>-nic user</code> for networking is that <code>ping</code> will not work, because
it uses the ICMP protocol.  You&rsquo;ll have to use a different command to check for
network connectivity, for example <code>guix download</code>.
</p>
<span id="Connecting-Through-SSH"></span><h4 class="subsection">12.17.1 Connecting Through SSH</h4>

<span id="index-SSH-2"></span>
<span id="index-SSH-server-2"></span>
<p>To enable SSH inside a VM you need to add an SSH server like
<code>openssh-service-type</code> to your VM (see <a href="Networking-Services.html"><code>openssh-service-type</code></a>).  In addition you need to forward the SSH port,
22 by default, to the host.  You can do this with
</p>
<div class="example">
<pre class="example">$(guix system vm config.scm) -nic user,model=virtio-net-pci,hostfwd=tcp::10022-:22
</pre></div>

<p>To connect to the VM you can run
</p>
<div class="example">
<pre class="example">ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -p 10022 localhost
</pre></div>

<p>The <code>-p</code> tells <code>ssh</code> the port you want to connect to.
<code>-o UserKnownHostsFile=/dev/null</code> prevents <code>ssh</code> from complaining
every time you modify your <code>config.scm</code> file and the
<code>-o StrictHostKeyChecking=no</code> prevents you from having to allow a
connection to an unknown host every time you connect.
</p>
<blockquote>
<p><b>Note:</b> If you find the above &lsquo;<samp>hostfwd</samp>&rsquo; example not to be working (e.g.,
your SSH client hangs attempting to connect to the mapped port of your
VM), make sure that your Guix System VM has networking support, such as
by using the <code>dhcp-client-service-type</code> service type.
</p></blockquote>

<span id="Using-virt_002dviewer-with-Spice"></span><h4 class="subsection">12.17.2 Using <code>virt-viewer</code> with Spice</h4>

<p>As an alternative to the default <code>qemu</code> graphical client you can
use the <code>remote-viewer</code> from the <code>virt-viewer</code> package.  To
connect pass the <code>-spice port=5930,disable-ticketing</code> flag to
<code>qemu</code>.  See previous section for further information on how to do this.
</p>
<p>Spice also allows you to do some nice stuff like share your clipboard with your
VM.  To enable that you&rsquo;ll also have to pass the following flags to <code>qemu</code>:
</p>
<div class="example">
<pre class="example">-device virtio-serial-pci,id=virtio-serial0,max_ports=16,bus=pci.0,addr=0x5
-chardev spicevmc,name=vdagent,id=vdagent
-device virtserialport,nr=1,bus=virtio-serial0.0,chardev=vdagent,\
name=com.redhat.spice.0
</pre></div>

<p>You&rsquo;ll also need to add the <code>(spice-vdagent-service)</code> to your
system definition (see <a href="Miscellaneous-Services.html">Spice service</a>).
</p>
<hr />
<div class="header">
<p>
Next: <a href="Defining-Services.html" accesskey="n" rel="next">Defining Services</a>, Previous: <a href="Invoking-guix-deploy.html" accesskey="p" rel="prev">Invoking guix deploy</a>, Up: <a href="System-Configuration.html" accesskey="u" rel="up">System Configuration</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Concept-Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
