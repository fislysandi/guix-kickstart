<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!--   Copyright (C) 2012-2022 Ludovic Courtès

Copyright (C) 2013, 2014, 2016 Andreas Enge

Copyright (C) 2013 Nikita Karetnikov

Copyright (C) 2014, 2015, 2016 Alex Kost

Copyright (C) 2015, 2016 Mathieu Lirzin

Copyright (C) 2014 Pierre-Antoine Rault

Copyright (C) 2015 Taylan Ulrich Bayırlı/Kammer

Copyright (C) 2015, 2016, 2017, 2019, 2020, 2021 Leo Famulari

Copyright (C) 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022 Ricardo Wurmus

Copyright (C) 2016 Ben Woodcroft

Copyright (C) 2016, 2017, 2018, 2021 Chris Marusich

Copyright (C) 2016, 2017, 2018, 2019, 2020, 2021, 2022 Efraim Flashner

Copyright (C) 2016 John Darrington

Copyright (C) 2016, 2017 Nikita Gillmann

Copyright (C) 2016, 2017, 2018, 2019, 2020 Jan Nieuwenhuizen

Copyright (C) 2016, 2017, 2018, 2019, 2020, 2021 Julien Lepiller

Copyright (C) 2016 Alex ter Weele

Copyright (C) 2016, 2017, 2018, 2019, 2020, 2021 Christopher Baines

Copyright (C) 2017, 2018, 2019 Clément Lassieur

Copyright (C) 2017, 2018, 2020, 2021, 2022 Mathieu Othacehe

Copyright (C) 2017 Federico Beffa

Copyright (C) 2017, 2018 Carlo Zancanaro

Copyright (C) 2017 Thomas Danckaert

Copyright (C) 2017 humanitiesNerd

Copyright (C) 2017, 2021 Christine Lemmer-Webber

Copyright (C) 2017, 2018, 2019, 2020, 2021, 2022 Marius Bakke

Copyright (C) 2017, 2019, 2020, 2022 Hartmut Goebel

Copyright (C) 2017, 2019, 2020, 2021, 2022 Maxim Cournoyer

Copyright (C) 2017–2022 Tobias Geerinckx-Rice

Copyright (C) 2017 George Clemmer

Copyright (C) 2017 Andy Wingo

Copyright (C) 2017, 2018, 2019, 2020 Arun Isaac

Copyright (C) 2017 nee

Copyright (C) 2018 Rutger Helling

Copyright (C) 2018, 2021 Oleg Pykhalov

Copyright (C) 2018 Mike Gerwitz

Copyright (C) 2018 Pierre-Antoine Rouby

Copyright (C) 2018, 2019 Gábor Boskovits

Copyright (C) 2018, 2019, 2020, 2022 Florian Pelz

Copyright (C) 2018 Laura Lazzati

Copyright (C) 2018 Alex Vong

Copyright (C) 2019 Josh Holland

Copyright (C) 2019, 2020 Diego Nicola Barbato

Copyright (C) 2019 Ivan Petkov

Copyright (C) 2019 Jakob L. Kreuze

Copyright (C) 2019 Kyle Andrews

Copyright (C) 2019 Alex Griffin

Copyright (C) 2019, 2020, 2021, 2022 Guillaume Le Vaillant

Copyright (C) 2020 Liliana Marie Prikler

Copyright (C) 2019, 2020, 2021, 2022 Simon Tournier

Copyright (C) 2020 Wiktor Żelazny

Copyright (C) 2020 Damien Cassou

Copyright (C) 2020 Jakub Kądziołka

Copyright (C) 2020 Jack Hill

Copyright (C) 2020 Naga Malleswari

Copyright (C) 2020, 2021 Brice Waegeneire

Copyright (C) 2020 R Veera Kumar

Copyright (C) 2020, 2021 Pierre Langlois

Copyright (C) 2020 pinoaffe

Copyright (C) 2020 André Batista

Copyright (C) 2020, 2021 Alexandru-Sergiu Marton

Copyright (C) 2020 raingloom

Copyright (C) 2020 Daniel Brooks

Copyright (C) 2020 John Soo

Copyright (C) 2020 Jonathan Brielmaier

Copyright (C) 2020 Edgar Vincent

Copyright (C) 2021, 2022 Maxime Devos

Copyright (C) 2021 B. Wilson

Copyright (C) 2021 Xinglu Chen

Copyright (C) 2021 Raghav Gururajan

Copyright (C) 2021 Domagoj Stolfa

Copyright (C) 2021 Hui Lu

Copyright (C) 2021 pukkamustard

Copyright (C) 2021 Alice Brenon

Copyright (C) 2021, 2022 Josselin Poiret

Copyright (C) 2021 muradm

Copyright (C) 2021, 2022 Andrew Tropin

Copyright (C) 2021 Sarah Morgensen

Copyright (C) 2022 Remco van 't Veer

Copyright (C) 2022 Aleksandr Vityazev

Copyright (C) 2022 Philip McGrath

Copyright (C) 2022 Karl Hallsby

Copyright (C) 2022 Justin Veilleux

Copyright (C) 2022 Reily Siegel

Copyright (C) 2022 Simon Streit

Copyright (C) 2022 (

Copyright (C) 2022 John Kehayias


Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with no
Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.  A
copy of the license is included in the section entitled "GNU Free
Documentation License".   -->
<!--   Created by GNU Texinfo 6.7, http://www.gnu.org/software/texinfo/   -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Daemon Offload Setup (GNU Guix Reference Manual)</title>

<meta name="description" content="Daemon Offload Setup (GNU Guix Reference Manual)" />
<meta name="keywords" content="Daemon Offload Setup (GNU Guix Reference Manual)" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="Generator" content="makeinfo" />
<link href="index.html" rel="start" title="Top" />
<link href="Concept-Index.html" rel="index" title="Concept Index" />
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents" />
<link href="Setting-Up-the-Daemon.html" rel="up" title="Setting Up the Daemon" />
<link href="SELinux-Support.html" rel="next" title="SELinux Support" />
<link href="Build-Environment-Setup.html" rel="prev" title="Build Environment Setup" />
<style type="text/css">
&amp;lt;!--
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
div.lisp {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
ul.no-bullet {list-style: none}
--&amp;gt;
</style>
<link rel="stylesheet" type="text/css" href="https://www.gnu.org/software/gnulib/manual.css" />

<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" type="text/css" href="../../../static/base/css/manual.css" /><link rel="stylesheet" type="text/css" href="../../../static/base/css/code.css" /></head>

<body lang="en"><header class="navbar"><h1><a class="branding" href="https://guix.gnu.org/manual/en/"></a></h1><nav class="navbar-menu"><input class="navbar-menu-hidden-input" type="radio" name="dropdown" id="all-dropdowns-hidden" /><ul><li class="navbar-menu-item dropdown dropdown-btn"><input class="navbar-menu-hidden-input" type="radio" name="dropdown" id="visible-dropdown" /><label for="visible-dropdown"><img alt="Language" src="../../../static/base/img/language-picker.svg" /></label><label for="all-dropdowns-hidden"><img alt="Language" src="../../../static/base/img/language-picker.svg" /></label><div class="navbar-submenu" id="navbar-submenu"><div class="navbar-submenu-triangle"> </div><ul><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/de/html_node">Deutsch</a></li><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/en/html_node">English</a></li><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/es/html_node">Español</a></li><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/fr/html_node">français</a></li><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/pt-br/html_node">Português</a></li><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/ru/html_node">русский</a></li><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/zh-cn/html_node">中文</a></li><li><a class="navbar-menu-item" href="https://translate.fedoraproject.org/projects/guix/documentation-manual/">⊕</a></li></ul></div></li></ul></nav><a class="navbar-menu-btn" href="https://guix.gnu.org/manual/"></a></header>
<span id="Daemon-Offload-Setup"></span><div class="header">
<p>
Next: <a href="SELinux-Support.html" accesskey="n" rel="next">SELinux Support</a>, Previous: <a href="Build-Environment-Setup.html" accesskey="p" rel="prev">Build Environment Setup</a>, Up: <a href="Setting-Up-the-Daemon.html" accesskey="u" rel="up">Setting Up the Daemon</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Concept-Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr />
<span id="Using-the-Offload-Facility"></span><h4 class="subsection">2.4.2 Using the Offload Facility</h4>

<span id="index-offloading"></span>
<span id="index-build-hook"></span>
<p>When desired, the build daemon can <em>offload</em> derivation builds to
other machines running Guix, using the <code>offload</code> <em>build
hook</em><a id="DOCF8" href="Daemon-Offload-Setup.html#FOOT8"><sup>8</sup></a>.  When that feature is enabled, a list of user-specified build
machines is read from <samp>/etc/guix/machines.scm</samp>; every time a build
is requested, for instance via <code>guix build</code>, the daemon attempts to
offload it to one of the machines that satisfy the constraints of the
derivation, in particular its system types&mdash;e.g., <code>x86_64-linux</code>.
A single machine can have multiple system types, either because its
architecture natively supports it, via emulation
(see <a href="Virtualization-Services.html#transparent_002demulation_002dqemu">Transparent Emulation with QEMU</a>),
or both.  Missing prerequisites for the build are
copied over SSH to the target machine, which then proceeds with the
build; upon success the output(s) of the build are copied back to the
initial machine.  The offload facility comes with a basic scheduler that
attempts to select the best machine.  The best machine is chosen among
the available machines based on criteria such as:
</p>
<ol>
<li> The availability of a build slot.  A build machine can have as many
build slots (connections) as the value of the <code>parallel-builds</code>
field of its <code>build-machine</code> object.

</li><li> Its relative speed, as defined via the <code>speed</code> field of its
<code>build-machine</code> object.

</li><li> Its load.  The normalized machine load must be lower than a threshold
value, configurable via the <code>overload-threshold</code> field of its
<code>build-machine</code> object.

</li><li> Disk space availability.  More than a 100 MiB must be available.
</li></ol>

<p>The <samp>/etc/guix/machines.scm</samp> file typically looks like this:
</p>
<div class="lisp">
<pre class="lisp"><span class="syntax-paren0">(<span class="syntax-symbol"><a class="syntax-symbol" href="https://www.gnu.org/software/guile/manual/html_node/List-Constructors.html#index-list-1">list</a> <span class="syntax-paren1">(<span class="syntax-symbol"><a class="syntax-symbol" href="Daemon-Offload-Setup.html#index-build_002dmachine">build-machine</a>
        <span class="syntax-paren2">(<span class="syntax-symbol"><span class="syntax-symbol">name</span> <span class="syntax-string">"eightysix.example.org"</span></span>)</span>
        <span class="syntax-paren2">(<span class="syntax-symbol"><span class="syntax-symbol">systems</span> <span class="syntax-paren3">(<span class="syntax-symbol"><a class="syntax-symbol" href="https://www.gnu.org/software/guile/manual/html_node/List-Constructors.html#index-list-1">list</a> <span class="syntax-string">"x86_64-linux"</span> <span class="syntax-string">"i686-linux"</span></span>)</span></span>)</span>
        <span class="syntax-paren2">(<span class="syntax-symbol"><span class="syntax-symbol">host-key</span> <span class="syntax-string">"ssh-ed25519 AAAAC3Nza…"</span></span>)</span>
        <span class="syntax-paren2">(<span class="syntax-symbol"><span class="syntax-symbol">user</span> <span class="syntax-string">"bob"</span></span>)</span>
        <span class="syntax-paren2">(<span class="syntax-symbol"><span class="syntax-symbol">speed</span> <span class="syntax-symbol">2.</span></span>)</span></span>)</span>     <span class="syntax-comment">;incredibly fast!
</span>
      <span class="syntax-paren1">(<span class="syntax-symbol"><a class="syntax-symbol" href="Daemon-Offload-Setup.html#index-build_002dmachine">build-machine</a>
        <span class="syntax-paren2">(<span class="syntax-symbol"><span class="syntax-symbol">name</span> <span class="syntax-string">"armeight.example.org"</span></span>)</span>
        <span class="syntax-paren2">(<span class="syntax-symbol"><span class="syntax-symbol">systems</span> <span class="syntax-paren3">(<span class="syntax-symbol"><a class="syntax-symbol" href="https://www.gnu.org/software/guile/manual/html_node/List-Constructors.html#index-list-1">list</a> <span class="syntax-string">"aarch64-linux"</span></span>)</span></span>)</span>
        <span class="syntax-paren2">(<span class="syntax-symbol"><span class="syntax-symbol">host-key</span> <span class="syntax-string">"ssh-rsa AAAAB3Nza…"</span></span>)</span>
        <span class="syntax-paren2">(<span class="syntax-symbol"><span class="syntax-symbol">user</span> <span class="syntax-string">"alice"</span></span>)</span>

        <span class="syntax-comment">;; Remember 'guix offload' is spawned by
</span>        <span class="syntax-comment">;; 'guix-daemon' as root.
</span>        <span class="syntax-paren2">(<span class="syntax-symbol"><span class="syntax-symbol">private-key</span> <span class="syntax-string">"/root/.ssh/identity-for-guix"</span></span>)</span></span>)</span></span>)</span>
</pre></div>

<p>In the example above we specify a list of two build machines, one for
the <code>x86_64</code> and <code>i686</code> architectures and one for the
<code>aarch64</code> architecture.
</p>
<p>In fact, this file is&mdash;not surprisingly!&mdash;a Scheme file that is
evaluated when the <code>offload</code> hook is started.  Its return value
must be a list of <code>build-machine</code> objects.  While this example
shows a fixed list of build machines, one could imagine, say, using
DNS-SD to return a list of potential build machines discovered in the
local network (see <a href="http://nongnu.org/guile-avahi/doc/guile-avahi.html#Introduction">Guile-Avahi</a> in <cite>Using
Avahi in Guile Scheme Programs</cite>).  The <code>build-machine</code> data type is
detailed below.
</p>
<dl>
<dt id="index-build_002dmachine" class="symbol-definition"><span class="symbol-definition-category">Data Type: </span><span class="symbol-definition-prototype">build-machine </span></dt>
<dd><p>This data type represents build machines to which the daemon may offload
builds.  The important fields are:
</p>
<dl compact="compact">
<dt><code>name</code></dt>
<dd><p>The host name of the remote machine.
</p>
</dd>
<dt><code>systems</code></dt>
<dd><p>The system types the remote machine supports&mdash;e.g., <code>(list
"x86_64-linux" "i686-linux")</code>.
</p>
</dd>
<dt><code>user</code></dt>
<dd><p>The user account to use when connecting to the remote machine over SSH.
Note that the SSH key pair must <em>not</em> be passphrase-protected, to
allow non-interactive logins.
</p>
</dd>
<dt><code>host-key</code></dt>
<dd><p>This must be the machine&rsquo;s SSH <em>public host key</em> in OpenSSH format.
This is used to authenticate the machine when we connect to it.  It is a
long string that looks like this:
</p>
<div class="example">
<pre class="example">ssh-ed25519 AAAAC3NzaC&hellip;mde+UhL hint@example.org
</pre></div>

<p>If the machine is running the OpenSSH daemon, <code>sshd</code>, the host
key can be found in a file such as
<samp>/etc/ssh/ssh_host_ed25519_key.pub</samp>.
</p>
<p>If the machine is running the SSH daemon of GNU&nbsp;lsh,
<code>lshd</code>, the host key is in <samp>/etc/lsh/host-key.pub</samp> or a
similar file.  It can be converted to the OpenSSH format using
<code>lsh-export-key</code> (see <a href="http://www.lysator.liu.se/~nisse/lsh/lsh.html#Converting-keys">Converting keys</a> in <cite>LSH Manual</cite>):
</p>
<div class="example">
<pre class="example">$ lsh-export-key --openssh &lt; /etc/lsh/host-key.pub
ssh-rsa AAAAB3NzaC1yc2EAAAAEOp8FoQAAAQEAs1eB46LV&hellip;
</pre></div>

</dd>
</dl>

<p>A number of optional fields may be specified:
</p>
<dl compact="compact">
<dt><code>port</code> (default: <code>22</code>)</dt>
<dd><p>Port number of SSH server on the machine.
</p>
</dd>
<dt><code>private-key</code> (default: <samp>~root/.ssh/id_rsa</samp>)</dt>
<dd><p>The SSH private key file to use when connecting to the machine, in
OpenSSH format.  This key must not be protected with a passphrase.
</p>
<p>Note that the default value is the private key <em>of the root
account</em>.  Make sure it exists if you use the default.
</p>
</dd>
<dt><code>compression</code> (default: <code>"zlib@openssh.com,zlib"</code>)</dt>
<dt><code>compression-level</code> (default: <code>3</code>)</dt>
<dd><p>The SSH-level compression methods and compression level requested.
</p>
<p>Note that offloading relies on SSH compression to reduce bandwidth usage
when transferring files to and from build machines.
</p>
</dd>
<dt><code>daemon-socket</code> (default: <code>"/var/guix/daemon-socket/socket"</code>)</dt>
<dd><p>File name of the Unix-domain socket <code>guix-daemon</code> is listening
to on that machine.
</p>
</dd>
<dt><code>overload-threshold</code> (default: <code>0.8</code>)</dt>
<dd><p>The load threshold above which a potential offload machine is
disregarded by the offload scheduler.  The value roughly translates to
the total processor usage of the build machine, ranging from 0.0 (0%) to
1.0 (100%).  It can also be disabled by setting
<code>overload-threshold</code> to <code>#f</code>.
</p>
</dd>
<dt><code>parallel-builds</code> (default: <code>1</code>)</dt>
<dd><p>The number of builds that may run in parallel on the machine.
</p>
</dd>
<dt><code>speed</code> (default: <code>1.0</code>)</dt>
<dd><p>A &ldquo;relative speed factor&rdquo;.  The offload scheduler will tend to prefer
machines with a higher speed factor.
</p>
</dd>
<dt><code>features</code> (default: <code>'()</code>)</dt>
<dd><p>A list of strings denoting specific features supported by the machine.
An example is <code>"kvm"</code> for machines that have the KVM Linux modules
and corresponding hardware support.  Derivations can request features by
name, and they will be scheduled on matching build machines.
</p>
</dd>
</dl>
</dd></dl>

<p>The <code>guix</code> command must be in the search path on the build
machines.  You can check whether this is the case by running:
</p>
<div class="example">
<pre class="example">ssh build-machine guix repl --version
</pre></div>

<p>There is one last thing to do once <samp>machines.scm</samp> is in place.  As
explained above, when offloading, files are transferred back and forth
between the machine stores.  For this to work, you first need to
generate a key pair on each machine to allow the daemon to export signed
archives of files from the store (see <a href="Invoking-guix-archive.html">Invoking guix archive</a>):
</p>
<div class="example">
<pre class="example"># guix archive --generate-key
</pre></div>

<p>Each build machine must authorize the key of the master machine so that
it accepts store items it receives from the master:
</p>
<div class="example">
<pre class="example"># guix archive --authorize &lt; master-public-key.txt
</pre></div>

<p>Likewise, the master machine must authorize the key of each build machine.
</p>
<p>All the fuss with keys is here to express pairwise mutual trust
relations between the master and the build machines.  Concretely, when
the master receives files from a build machine (and <i>vice versa</i>), its
build daemon can make sure they are genuine, have not been tampered
with, and that they are signed by an authorized key.
</p>
<span id="index-offload-test"></span>
<p>To test whether your setup is operational, run this command on the
master node:
</p>
<div class="example">
<pre class="example"># guix offload test
</pre></div>

<p>This will attempt to connect to each of the build machines specified in
<samp>/etc/guix/machines.scm</samp>, make sure Guix is
available on each machine, attempt to export to the machine and import
from it, and report any error in the process.
</p>
<p>If you want to test a different machine file, just specify it on the
command line:
</p>
<div class="example">
<pre class="example"># guix offload test machines-qualif.scm
</pre></div>

<p>Last, you can test the subset of the machines whose name matches a
regular expression like this:
</p>
<div class="example">
<pre class="example"># guix offload test machines.scm '\.gnu\.org$'
</pre></div>

<span id="index-offload-status"></span>
<p>To display the current load of all build hosts, run this command on the
main node:
</p>
<div class="example">
<pre class="example"># guix offload status
</pre></div>


<div class="footnote">
<hr />
<h4 class="footnotes-heading">Footnotes</h4>

<h5><a id="FOOT8" href="Daemon-Offload-Setup.html#DOCF8">(8)</a>
<p>This feature is available only when
<a href="https://github.com/artyom-poptsov/guile-ssh">Guile-SSH</a> is
present.</p>
</h5></div>
<hr />
<div class="header">
<p>
Next: <a href="SELinux-Support.html" accesskey="n" rel="next">SELinux Support</a>, Previous: <a href="Build-Environment-Setup.html" accesskey="p" rel="prev">Build Environment Setup</a>, Up: <a href="Setting-Up-the-Daemon.html" accesskey="u" rel="up">Setting Up the Daemon</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Concept-Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
