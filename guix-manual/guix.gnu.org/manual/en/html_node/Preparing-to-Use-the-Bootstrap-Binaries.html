<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!--   Copyright (C) 2012-2022 Ludovic Courtès

Copyright (C) 2013, 2014, 2016 Andreas Enge

Copyright (C) 2013 Nikita Karetnikov

Copyright (C) 2014, 2015, 2016 Alex Kost

Copyright (C) 2015, 2016 Mathieu Lirzin

Copyright (C) 2014 Pierre-Antoine Rault

Copyright (C) 2015 Taylan Ulrich Bayırlı/Kammer

Copyright (C) 2015, 2016, 2017, 2019, 2020, 2021 Leo Famulari

Copyright (C) 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022 Ricardo Wurmus

Copyright (C) 2016 Ben Woodcroft

Copyright (C) 2016, 2017, 2018, 2021 Chris Marusich

Copyright (C) 2016, 2017, 2018, 2019, 2020, 2021, 2022 Efraim Flashner

Copyright (C) 2016 John Darrington

Copyright (C) 2016, 2017 Nikita Gillmann

Copyright (C) 2016, 2017, 2018, 2019, 2020 Jan Nieuwenhuizen

Copyright (C) 2016, 2017, 2018, 2019, 2020, 2021 Julien Lepiller

Copyright (C) 2016 Alex ter Weele

Copyright (C) 2016, 2017, 2018, 2019, 2020, 2021 Christopher Baines

Copyright (C) 2017, 2018, 2019 Clément Lassieur

Copyright (C) 2017, 2018, 2020, 2021, 2022 Mathieu Othacehe

Copyright (C) 2017 Federico Beffa

Copyright (C) 2017, 2018 Carlo Zancanaro

Copyright (C) 2017 Thomas Danckaert

Copyright (C) 2017 humanitiesNerd

Copyright (C) 2017, 2021 Christine Lemmer-Webber

Copyright (C) 2017, 2018, 2019, 2020, 2021, 2022 Marius Bakke

Copyright (C) 2017, 2019, 2020, 2022 Hartmut Goebel

Copyright (C) 2017, 2019, 2020, 2021, 2022 Maxim Cournoyer

Copyright (C) 2017–2022 Tobias Geerinckx-Rice

Copyright (C) 2017 George Clemmer

Copyright (C) 2017 Andy Wingo

Copyright (C) 2017, 2018, 2019, 2020 Arun Isaac

Copyright (C) 2017 nee

Copyright (C) 2018 Rutger Helling

Copyright (C) 2018, 2021 Oleg Pykhalov

Copyright (C) 2018 Mike Gerwitz

Copyright (C) 2018 Pierre-Antoine Rouby

Copyright (C) 2018, 2019 Gábor Boskovits

Copyright (C) 2018, 2019, 2020, 2022 Florian Pelz

Copyright (C) 2018 Laura Lazzati

Copyright (C) 2018 Alex Vong

Copyright (C) 2019 Josh Holland

Copyright (C) 2019, 2020 Diego Nicola Barbato

Copyright (C) 2019 Ivan Petkov

Copyright (C) 2019 Jakob L. Kreuze

Copyright (C) 2019 Kyle Andrews

Copyright (C) 2019 Alex Griffin

Copyright (C) 2019, 2020, 2021, 2022 Guillaume Le Vaillant

Copyright (C) 2020 Liliana Marie Prikler

Copyright (C) 2019, 2020, 2021, 2022 Simon Tournier

Copyright (C) 2020 Wiktor Żelazny

Copyright (C) 2020 Damien Cassou

Copyright (C) 2020 Jakub Kądziołka

Copyright (C) 2020 Jack Hill

Copyright (C) 2020 Naga Malleswari

Copyright (C) 2020, 2021 Brice Waegeneire

Copyright (C) 2020 R Veera Kumar

Copyright (C) 2020, 2021 Pierre Langlois

Copyright (C) 2020 pinoaffe

Copyright (C) 2020 André Batista

Copyright (C) 2020, 2021 Alexandru-Sergiu Marton

Copyright (C) 2020 raingloom

Copyright (C) 2020 Daniel Brooks

Copyright (C) 2020 John Soo

Copyright (C) 2020 Jonathan Brielmaier

Copyright (C) 2020 Edgar Vincent

Copyright (C) 2021, 2022 Maxime Devos

Copyright (C) 2021 B. Wilson

Copyright (C) 2021 Xinglu Chen

Copyright (C) 2021 Raghav Gururajan

Copyright (C) 2021 Domagoj Stolfa

Copyright (C) 2021 Hui Lu

Copyright (C) 2021 pukkamustard

Copyright (C) 2021 Alice Brenon

Copyright (C) 2021, 2022 Josselin Poiret

Copyright (C) 2021 muradm

Copyright (C) 2021, 2022 Andrew Tropin

Copyright (C) 2021 Sarah Morgensen

Copyright (C) 2022 Remco van 't Veer

Copyright (C) 2022 Aleksandr Vityazev

Copyright (C) 2022 Philip McGrath

Copyright (C) 2022 Karl Hallsby

Copyright (C) 2022 Justin Veilleux

Copyright (C) 2022 Reily Siegel

Copyright (C) 2022 Simon Streit

Copyright (C) 2022 (

Copyright (C) 2022 John Kehayias


Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with no
Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.  A
copy of the license is included in the section entitled "GNU Free
Documentation License".   -->
<!--   Created by GNU Texinfo 6.7, http://www.gnu.org/software/texinfo/   -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Preparing to Use the Bootstrap Binaries (GNU Guix Reference Manual)</title>

<meta name="description" content="Preparing to Use the Bootstrap Binaries (GNU Guix Reference Manual)" />
<meta name="keywords" content="Preparing to Use the Bootstrap Binaries (GNU Guix Reference Manual)" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="Generator" content="makeinfo" />
<link href="index.html" rel="start" title="Top" />
<link href="Concept-Index.html" rel="index" title="Concept Index" />
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents" />
<link href="Bootstrapping.html" rel="up" title="Bootstrapping" />
<link href="Porting.html" rel="next" title="Porting" />
<link href="Reduced-Binary-Seed-Bootstrap.html" rel="prev" title="Reduced Binary Seed Bootstrap" />
<style type="text/css">
&amp;lt;!--
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
div.lisp {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
ul.no-bullet {list-style: none}
--&amp;gt;
</style>
<link rel="stylesheet" type="text/css" href="https://www.gnu.org/software/gnulib/manual.css" />

<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" type="text/css" href="../../../static/base/css/manual.css" /><link rel="stylesheet" type="text/css" href="../../../static/base/css/code.css" /></head>

<body lang="en"><header class="navbar"><h1><a class="branding" href="https://guix.gnu.org/manual/en/"></a></h1><nav class="navbar-menu"><input class="navbar-menu-hidden-input" type="radio" name="dropdown" id="all-dropdowns-hidden" /><ul><li class="navbar-menu-item dropdown dropdown-btn"><input class="navbar-menu-hidden-input" type="radio" name="dropdown" id="visible-dropdown" /><label for="visible-dropdown"><img alt="Language" src="../../../static/base/img/language-picker.svg" /></label><label for="all-dropdowns-hidden"><img alt="Language" src="../../../static/base/img/language-picker.svg" /></label><div class="navbar-submenu" id="navbar-submenu"><div class="navbar-submenu-triangle"> </div><ul><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/de/html_node">Deutsch</a></li><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/en/html_node">English</a></li><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/es/html_node">Español</a></li><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/fr/html_node">français</a></li><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/pt-br/html_node">Português</a></li><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/ru/html_node">русский</a></li><li><a class="navbar-menu-item" href="https://guix.gnu.org/manual/zh-cn/html_node">中文</a></li><li><a class="navbar-menu-item" href="https://translate.fedoraproject.org/projects/guix/documentation-manual/">⊕</a></li></ul></div></li></ul></nav><a class="navbar-menu-btn" href="https://guix.gnu.org/manual/"></a></header>
<span id="Preparing-to-Use-the-Bootstrap-Binaries"></span><div class="header">
<p>
Previous: <a href="Reduced-Binary-Seed-Bootstrap.html" accesskey="p" rel="prev">Reduced Binary Seed Bootstrap</a>, Up: <a href="Bootstrapping.html" accesskey="u" rel="up">Bootstrapping</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Concept-Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr />
<span id="Preparing-to-Use-the-Bootstrap-Binaries-1"></span><h3 class="section">20.2 Preparing to Use the Bootstrap Binaries</h3>

<img src="images/bootstrap-graph.png" alt="Dependency graph of the early bootstrap derivations" />

<p>The figure above shows the very beginning of the dependency graph of the
distribution, corresponding to the package definitions of the <code>(gnu
packages bootstrap)</code> module.  A similar figure can be generated with
<code>guix graph</code> (see <a href="Invoking-guix-graph.html">Invoking guix graph</a>), along the lines of:
</p>
<div class="example">
<pre class="example">guix graph -t derivation \
  -e '(@@ (gnu packages bootstrap) %bootstrap-gcc)' \
  | dot -Tps &gt; gcc.ps
</pre></div>

<p>or, for the further Reduced Binary Seed bootstrap
</p>
<div class="example">
<pre class="example">guix graph -t derivation \
  -e '(@@ (gnu packages bootstrap) %bootstrap-mes)' \
  | dot -Tps &gt; mes.ps
</pre></div>

<p>At this level of detail, things are
slightly complex.  First, Guile itself consists of an ELF executable,
along with many source and compiled Scheme files that are dynamically
loaded when it runs.  This gets stored in the <samp>guile-2.0.7.tar.xz</samp>
tarball shown in this graph.  This tarball is part of Guix&rsquo;s &ldquo;source&rdquo;
distribution, and gets inserted into the store with <code>add-to-store</code>
(see <a href="The-Store.html">The Store</a>).
</p>
<p>But how do we write a derivation that unpacks this tarball and adds it
to the store?  To solve this problem, the <code>guile-bootstrap-2.0.drv</code>
derivation&mdash;the first one that gets built&mdash;uses <code>bash</code> as its
builder, which runs <code>build-bootstrap-guile.sh</code>, which in turn calls
<code>tar</code> to unpack the tarball.  Thus, <samp>bash</samp>, <samp>tar</samp>,
<samp>xz</samp>, and <samp>mkdir</samp> are statically-linked binaries, also part of
the Guix source distribution, whose sole purpose is to allow the Guile
tarball to be unpacked.
</p>
<p>Once <code>guile-bootstrap-2.0.drv</code> is built, we have a functioning
Guile that can be used to run subsequent build programs.  Its first task
is to download tarballs containing the other pre-built binaries&mdash;this
is what the <samp>.tar.xz.drv</samp> derivations do.  Guix modules such as
<code>ftp-client.scm</code> are used for this purpose.  The
<code>module-import.drv</code> derivations import those modules in a directory
in the store, using the original layout.  The
<code>module-import-compiled.drv</code> derivations compile those modules, and
write them in an output directory with the right layout.  This
corresponds to the <code>#:modules</code> argument of
<code>build-expression-&gt;derivation</code> (see <a href="Derivations.html">Derivations</a>).
</p>
<p>Finally, the various tarballs are unpacked by the derivations
<code>gcc-bootstrap-0.drv</code>, <code>glibc-bootstrap-0.drv</code>, or
<code>bootstrap-mes-0.drv</code> and <code>bootstrap-mescc-tools-0.drv</code>, at which
point we have a working C tool chain.
</p>
<span id="Building-the-Build-Tools"></span><h3 class="unnumberedsec">Building the Build Tools</h3>

<p>Bootstrapping is complete when we have a full tool chain that does not
depend on the pre-built bootstrap tools discussed above.  This
no-dependency requirement is verified by checking whether the files of
the final tool chain contain references to the <samp>/gnu/store</samp>
directories of the bootstrap inputs.  The process that leads to this
&ldquo;final&rdquo; tool chain is described by the package definitions found in
the <code>(gnu packages commencement)</code> module.
</p>
<p>The <code>guix graph</code> command allows us to &ldquo;zoom out&rdquo; compared to
the graph above, by looking at the level of package objects instead of
individual derivations&mdash;remember that a package may translate to
several derivations, typically one derivation to download its source,
one to build the Guile modules it needs, and one to actually build the
package from source.  The command:
</p>
<div class="example">
<pre class="example">guix graph -t bag \
  -e '(@@ (gnu packages commencement)
          glibc-final-with-bootstrap-bash)' | xdot -
</pre></div>

<p>displays the dependency graph leading to the &ldquo;final&rdquo; C
library<a id="DOCF39" href="Preparing-to-Use-the-Bootstrap-Binaries.html#FOOT39"><sup>39</sup></a>, depicted below.
</p>
<img src="images/bootstrap-packages.png" alt="Dependency graph of the early packages" />

<p>The first tool that gets built with the bootstrap binaries is
GNU&nbsp;Make&mdash;noted <code>make-boot0</code> above&mdash;which is a prerequisite
for all the following packages.  From there Findutils and Diffutils get
built.
</p>
<p>Then come the first-stage Binutils and GCC, built as pseudo cross
tools&mdash;i.e., with <samp>--target</samp> equal to <samp>--host</samp>.  They are
used to build libc.  Thanks to this cross-build trick, this libc is
guaranteed not to hold any reference to the initial tool chain.
</p>
<p>From there the final Binutils and GCC (not shown above) are built.  GCC
uses <code>ld</code> from the final Binutils, and links programs against
the just-built libc.  This tool chain is used to build the other
packages used by Guix and by the GNU Build System: Guile, Bash,
Coreutils, etc.
</p>
<p>And voilà!  At this point we have the complete set of build tools that
the GNU Build System expects.  These are in the <code>%final-inputs</code>
variable of the <code>(gnu packages commencement)</code> module, and are
implicitly used by any package that uses <code>gnu-build-system</code>
(see <a href="Build-Systems.html"><code>gnu-build-system</code></a>).
</p>

<span id="Building-the-Bootstrap-Binaries"></span><h3 class="unnumberedsec">Building the Bootstrap Binaries</h3>

<span id="index-bootstrap-binaries-1"></span>
<p>Because the final tool chain does not depend on the bootstrap binaries,
those rarely need to be updated.  Nevertheless, it is useful to have an
automated way to produce them, should an update occur, and this is what
the <code>(gnu packages make-bootstrap)</code> module provides.
</p>
<p>The following command builds the tarballs containing the bootstrap binaries
(Binutils, GCC, glibc, for the traditional bootstrap and linux-libre-headers,
bootstrap-mescc-tools, bootstrap-mes for the Reduced Binary Seed bootstrap,
and Guile, and a tarball containing a mixture of Coreutils and other basic
command-line tools):
</p>
<div class="example">
<pre class="example">guix build bootstrap-tarballs
</pre></div>

<p>The generated tarballs are those that should be referred to in the
<code>(gnu packages bootstrap)</code> module mentioned at the beginning of
this section.
</p>
<p>Still here?  Then perhaps by now you&rsquo;ve started to wonder: when do we
reach a fixed point?  That is an interesting question!  The answer is
unknown, but if you would like to investigate further (and have
significant computational and storage resources to do so), then let us
know.
</p>
<span id="Reducing-the-Set-of-Bootstrap-Binaries"></span><h3 class="unnumberedsec">Reducing the Set of Bootstrap Binaries</h3>

<p>Our traditional bootstrap includes GCC, GNU Libc, Guile, etc.  That&rsquo;s a lot of
binary code!  Why is that a problem?  It&rsquo;s a problem because these big chunks
of binary code are practically non-auditable, which makes it hard to establish
what source code produced them.  Every unauditable binary also leaves us
vulnerable to compiler backdoors as described by Ken Thompson in the 1984
paper <em>Reflections on Trusting Trust</em>.
</p>
<p>This is mitigated by the fact that our bootstrap binaries were generated
from an earlier Guix revision.  Nevertheless it lacks the level of
transparency that we get in the rest of the package dependency graph,
where Guix always gives us a source-to-binary mapping.  Thus, our goal
is to reduce the set of bootstrap binaries to the bare minimum.
</p>
<p>The <a href="https://bootstrappable.org">Bootstrappable.org web site</a> lists
on-going projects to do that.  One of these is about replacing the
bootstrap GCC with a sequence of assemblers, interpreters, and compilers
of increasing complexity, which could be built from source starting from
a simple and auditable assembler.
</p>
<p>Our first major achievement is the replacement of of GCC, the GNU C Library
and Binutils by MesCC-Tools (a simple hex linker and macro assembler) and Mes
(see <a href="https://www.gnu.org/software/mes/manual/html_node/index.html#Top">GNU Mes Reference Manual</a> in <cite>GNU Mes</cite>, a Scheme interpreter
and C compiler in Scheme).  Neither MesCC-Tools nor Mes can be fully
bootstrapped yet and thus we inject them as binary seeds.  We call this the
Reduced Binary Seed bootstrap, as it has halved the size of our bootstrap
binaries!  Also, it has eliminated the C compiler binary; i686-linux and
x86_64-linux Guix packages are now bootstrapped without any binary C compiler.
</p>
<p>Work is ongoing to make MesCC-Tools and Mes fully bootstrappable and we are
also looking at any other bootstrap binaries.  Your help is welcome!
</p>
<div class="footnote">
<hr />
<h4 class="footnotes-heading">Footnotes</h4>

<h5><a id="FOOT39" href="Preparing-to-Use-the-Bootstrap-Binaries.html#DOCF39">(39)</a>
<p>You may notice the <code>glibc-intermediate</code> label,
suggesting that it is not <em>quite</em> final, but as a good
approximation, we will consider it final.</p>
</h5></div>
<hr />
<div class="header">
<p>
Previous: <a href="Reduced-Binary-Seed-Bootstrap.html" accesskey="p" rel="prev">Reduced Binary Seed Bootstrap</a>, Up: <a href="Bootstrapping.html" accesskey="u" rel="up">Bootstrapping</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Concept-Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
